name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Enable Corepack
        run: corepack enable

      - name: Configure Git for Yarn
        run: |
          git config --global core.autocrlf false
          git config --global core.eol lf

      - name: Install dependencies
        run: yarn install --immutable

      - name: Semantic Release
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        with:
          semantic_version: 24
          extra_plugins: |
            @semantic-release/changelog@6
            @semantic-release/git@10
            @semantic-release/exec@6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-electron:
    needs: release
    if: needs.release.outputs.new_release_published == 'true'
    strategy:
      fail-fast: true
      matrix:
        include:
          - os: macos-15-intel
            platform: mac
            arch: x64
          - os: macos-latest
            platform: mac
            arch: arm64
          - os: windows-latest
            platform: win
            arch: x64
          - os: ubuntu-latest
            platform: linux
            arch: x64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Pull latest changes (after semantic-release)
        run: git pull origin main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Enable Corepack
        run: corepack enable

      - name: Configure Git for Yarn
        run: |
          git config --global core.autocrlf false
          git config --global core.eol lf

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build Electron app (no publish)
        run: yarn build:electron
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: electron-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            dist/electron/Packaged/*.dmg
            dist/electron/Packaged/*.zip
            dist/electron/Packaged/*.exe
            dist/electron/Packaged/*.AppImage
            dist/electron/Packaged/*.deb
            dist/electron/Packaged/*.yml
            dist/electron/Packaged/*.blockmap
          if-no-files-found: error

  upload-release:
    needs: [release, build-electron]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: find artifacts -type f | head -50

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.release.outputs.new_release_version }}
          files: artifacts/*
          body: |
            ## Download Instructions

            ### macOS
            | Chip | File |
            |------|------|
            | **Apple Silicon (M1/M2/M3/M4)** | `*-mac-arm64.dmg` |
            | **Intel** | `*-mac-x64.dmg` |

            > ðŸ’¡ Not sure? Click  â†’ About This Mac â†’ check "Chip" field

            ### Windows
            | Type | File |
            |------|------|
            | **Installer** | `*-win-x64.exe` |

            ### Linux
            | Format | File |
            |--------|------|
            | **AppImage** (universal) | `*-linux-x86_64.AppImage` |
            | **Debian/Ubuntu** | `*-linux-amd64.deb` |

            ---
            *Auto-update is enabled. The app will notify you when new versions are available.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
